<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ page.name }} — {{ site.title }}</title>
  
  <!-- Preconnect a dominios externos críticos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://script.google.com">
  
  <!-- Fuentes optimizadas con font-display swap -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet"></noscript>
  
  <style>
  /* Critical CSS inline - same styles */
  :root{
    --blue-900:#0628b5;
    --blue-700:#0b32d1;
    --muted:#8c8c8c;
    --bg:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:Montserrat,system-ui,Arial,sans-serif;background:var(--bg);color:#111;margin:0;padding:20px;display:flex;align-items:flex-start;justify-content:center}
  .ecard{width:100%;max-width:420px;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 6px 24px rgba(2,6,23,0.08);display:flex;flex-direction:column}
  .ecard__header{padding:28px 20px 12px 20px;text-align:center;position:relative}
  .hero-bg{height:80px;background:linear-gradient(180deg,var(--blue-900),#2a45d9);border-bottom-left-radius:60% 40px;border-bottom-right-radius:60% 40px;position:absolute;left:0;right:0;top:0}
  .avatar-wrap{position:relative;margin:40px auto 0 auto;width:140px;height:140px;border-radius:50%;transform:translateY(28px);overflow:hidden;background:#fff;padding:6px;box-shadow:0 4px 12px rgba(2,6,23,0.08)}
  .avatar{width:100%;height:100%;object-fit:cover;border-radius:50%;display:block}
  .name{margin:44px 0 6px 0;font-family:Merriweather,serif;font-size:24px;color:#111}
  .role{margin:0;color:var(--muted);font-size:14px}
  .ctas{display:flex;flex-direction:column;gap:12px;margin-top:18px}
  .btn{display:inline-block;padding:12px 18px;border-radius:26px;text-decoration:none;font-weight:600;color:var(--bg);background:linear-gradient(180deg,var(--blue-700),var(--blue-900));border:3px solid rgba(3,23,120,0.06);box-shadow:inset 0 -4px 0 rgba(0,0,0,0.06);}
  .btn--primary{color:#fff}
  .info{padding:18px 18px 28px;flex:1}
  .row{display:flex;align-items:center;gap:14px;padding:14px 0}
  .icon{width:44px;height:44px;display:flex;align-items:center;justify-content:center}
  .content{flex:1}
  .icon-img{width:28px;height:28px;display:block}
  .social-img{width:48px;height:48px;display:block}
  .label{font-size:13px;color:var(--muted);}
  .value{font-size:16px;color:#111;margin-top:4px}
  hr{border:none;border-top:2px solid rgba(0,0,0,0.06);margin:0}
  .socials{display:flex;gap:24px;padding:18px 0;justify-content:center;align-items:center}
  .social{display:inline-flex;align-items:center;justify-content:center;text-decoration:none;border-radius:8px;padding:6px}
  .social-img{width:56px;height:56px;display:block}
  .download-footer{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--blue-700),var(--blue-900));padding:14px;margin-top:8px;width:100%;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .download-footer__link{display:inline-flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:700;padding:12px 18px;border-radius:12px}
  .download-footer__icon{display:inline-flex;align-items:center;justify-content:center}
  .download-footer__text{font-size:15px}
  @media(min-width:560px){
    body{padding:36px}
    .ecard{max-width:460px}
    .ctas{flex-direction:row;justify-content:center}
    .btn{min-width:140px}
    .download-footer{padding:14px}
  }
  .btn:active{transform:translateY(1px)}
  .social:active{opacity:0.85}
  </style>
</head>
<body>
  <main class="ecard">
    <header class="ecard__header">
      <div class="hero-bg" aria-hidden="true"></div>
      <div style="width:100%;display:flex;justify-content:center;margin-bottom:10px;position:absolute;left:0;right:0;top:16px;z-index:10;pointer-events:none;">
        <img src="{{ site.url }}{{ site.baseurl }}/assets/icons/alico.png" alt="Logo Alico" width="160" height="48" loading="eager" style="height:48px;max-width:160px;object-fit:contain;pointer-events:auto;" />
      </div>
      
      {% assign person_slug = page.slug %}
      {% if person_slug == nil or person_slug == '' %}
        {% assign person_slug = page.path | split: '/' | last | replace: '.md','' %}
      {% endif %}

      {% if page.image %}
        {% assign avatar_raw = page.image %}
        {% if avatar_raw contains '://' %}
          {% assign avatar_url = avatar_raw %}
        {% else %}
          {% assign avatar_url = avatar_raw | relative_url %}
        {% endif %}
      {% else %}
        {% assign avatar_url = '/fotos/' | append: person_slug | append: '.jpg' | relative_url %}
      {% endif %}

      {% assign fallback_jpg = '/fotos/' | append: person_slug | append: '.jpg' | relative_url %}
      {% assign fallback_png = '/fotos/' | append: person_slug | append: '.png' | relative_url %}
      {% assign fallback_icon = '/assets/icons/briefcase.svg' | relative_url %}

      <div class="avatar-wrap">
        <img src="{{ avatar_url }}" alt="Avatar de {{ page.name }}" class="avatar" width="128" height="128" loading="eager"
          data-avatar-url="{{ avatar_url }}"
          data-fallbacks="{{ fallback_jpg }};{{ fallback_png }};{{ fallback_icon }}"
          data-slug="{{ person_slug }}"
          data-name="{{ page.name | escape }}" />
      </div>

      <h1 class="name">{{ page.name }}</h1>
      <p class="role">{{ page.role }}</p>

      <div class="ctas">
        <a class="btn btn--primary" id="callBtn" href="tel:{{ page.phone }}">Teléfono</a>
        <a class="btn btn--primary" id="emailBtn" href="mailto:{{ page.email }}">Email</a>
        <a class="btn btn--primary" id="siteBtn" href="https://alicoempaques.com" target="_blank" rel="noopener">Sitio Web</a>
      </div>
    </header>

    <section class="info">
      <div class="row">
        <div class="icon"> 
          <img class="icon-img" src="{{ site.url }}{{ site.baseurl }}/assets/icons/phone.svg" alt="Teléfono" width="28" height="28" loading="lazy" />
        </div>
        <div class="content">
          <div class="label">Teléfono</div>
          <div class="value">{{ page.phone }}</div>
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="icon">
          <img class="icon-img" src="{{ site.url }}{{ site.baseurl }}/assets/icons/email.svg" alt="Email" width="28" height="28" loading="lazy" />
        </div>
        <div class="content">
          <div class="label">Email</div>
          <div class="value">{{ page.email }}</div>
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 0 1 18 0z" stroke="#0628b5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="10" r="2.5" stroke="#0628b5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="content">
          <div class="label">Ciudad</div>
          <div class="value">{{ page.city }}</div>
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="icon">
          <img class="icon-img" src="{{ site.url }}{{ site.baseurl }}/assets/icons/globe.svg" alt="Sitio web" width="28" height="28" loading="lazy" />
        </div>
        <div class="content">
          <div class="label">Sitio web</div>
          <div class="value">https://alicoempaques.com</div>
        </div>
      </div>

      <hr />

      <div class="socials">
        {% if page.linkedin %}
        <a class="social" aria-label="LinkedIn de {{ page.name }}" href="{{ page.linkedin }}" target="_blank" rel="noopener noreferrer">
          <img class="social-img" src="{{ site.url }}{{ site.baseurl }}/assets/icons/linkedin.svg" alt="LinkedIn" width="56" height="56" loading="lazy" />
        </a>
        {% endif %}

        {% if page.whatsapp %}
        <a class="social" aria-label="WhatsApp de {{ page.name }}" href="{{ page.whatsapp }}" target="_blank" rel="noopener noreferrer">
          <img class="social-img" src="{{ site.url }}{{ site.baseurl }}/assets/icons/whatsapp.svg" alt="WhatsApp" width="56" height="56" loading="lazy" />
        </a>
        {% endif %}
      </div>

    </section>

    <footer class="download-footer" role="contentinfo">
      <a id="downloadVcard" class="download-footer__link" href="#" title="Descargar VCard">
        <span class="download-footer__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/></svg>
        </span>
        <span class="download-footer__text">Descargar VCard</span>
      </a>
    </footer>

  </main>

  <script id="person-data" type="application/json">{{ page | jsonify | replace: "</", "<\\/" }}</script>

  <script>
  // Optimized initialization - defer non-critical operations
  (function(){
    'use strict';
    
    let PERSON = {};
    try{
      const el = document.getElementById('person-data');
      if(el?.textContent) PERSON = JSON.parse(el.textContent);
    }catch(e){
      console.warn('Parse error:', e);
    }

    // Event handlers already work via href, but keep for JS enhancement
    const phone = PERSON.phone || '';
    const email = PERSON.email || '';
    const website = 'https://alicoempaques.com';

    const callBtn = document.getElementById('callBtn');
    const emailBtn = document.getElementById('emailBtn');
    const siteBtn = document.getElementById('siteBtn');

    // These are now fallbacks since href already set
    if(callBtn && phone) callBtn.onclick = ()=> window.location.href = `tel:${phone}`;
    if(emailBtn && email) emailBtn.onclick = ()=> window.location.href = `mailto:${email}`;
    if(siteBtn && website) siteBtn.onclick = ()=> window.open(website,'_blank','noopener');

    // Optimized avatar fallback system
    function initialsSvg(name, size){
      size = size || 300;
      let initials = '';
      if(name){
        const parts = name.trim().split(/\s+/);
        initials = (parts[0]||'').charAt(0) + (parts.length>1? (parts[parts.length-1]||'').charAt(0) : '');
        initials = initials.toUpperCase();
      }
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><rect width='100%' height='100%' fill='#0628b5'/><text x='50%' y='50%' font-family='Montserrat,Arial,sans-serif' font-size='${Math.round(size/5)}' fill='#fff' dominant-baseline='middle' text-anchor='middle'>${initials}</text></svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function tryLoadImage(url){
      return new Promise((resolve, reject)=>{
        if(!url) return reject();
        const img = new Image();
        img.onload = ()=> resolve(url);
        img.onerror = reject;
        img.src = url;
      });
    }

    function resolveAvatar(imgEl){
      if(!imgEl) return;
      const src = imgEl.getAttribute('data-avatar-url') || imgEl.src;
      const fallbacks = (imgEl.getAttribute('data-fallbacks')||'').split(';').filter(Boolean);
      const name = imgEl.getAttribute('data-name') || '';
      
      const candidates = [src, ...fallbacks];
      
      let chain = Promise.reject();
      candidates.forEach(url => {
        chain = chain.catch(()=> tryLoadImage(url));
      });
      
      chain.catch(()=> initialsSvg(name, 300))
        .then(finalUrl => { imgEl.src = finalUrl; })
        .catch(()=> { imgEl.src = initialsSvg(name, 300); });
    }

    // Resolve avatar
    const avatar = document.querySelector('img.avatar');
    if(avatar) resolveAvatar(avatar);

    // VCard download handler
    async function imageToBase64(img){
      if(!img) return null;
      const src = img.src;
      if(!src) return null;

      if(src.startsWith('data:')){
        const comma = src.indexOf(',');
        const meta = src.substring(5, comma);
        const data = src.substring(comma + 1);
        const mime = meta.split(';')[0] || 'image/png';
        const isBase64 = meta.includes(';base64');
        if(isBase64) return { mime, base64: data };
        try{ return { mime, base64: btoa(data) }; }catch(e){ return null; }
      }

      try{
        const resp = await fetch(src);
        if(!resp.ok) return null;
        const blob = await resp.blob();
        const mime = blob.type || 'image/jpeg';
        return new Promise((resolve)=>{
          const reader = new FileReader();
          reader.onloadend = ()=>{
            const result = reader.result;
            const base64 = result.substring(result.indexOf(',') + 1);
            resolve({ mime, base64 });
          };
          reader.onerror = ()=> resolve(null);
          reader.readAsDataURL(blob);
        });
      }catch(e){
        return null;
      }
    }

    const downloadLink = document.getElementById('downloadVcard');
    if(downloadLink){
      downloadLink.onclick = async function(e){
        e.preventDefault();

        const fullName = PERSON.name || 'Sin nombre';
        const lines = ['BEGIN:VCARD','VERSION:3.0'];
        
        const names = (fullName || '').split(' ');
        const first = names.shift() || '';
        const last = names.join(' ') || '';
        lines.push(`N:${last};${first};;;`);
        lines.push(`FN:${fullName}`);
        
        if(PERSON.role) lines.push(`TITLE:${PERSON.role}`);
        if(PERSON.company) lines.push(`ORG:${PERSON.company}`);
        if(PERSON.phone) lines.push(`TEL;TYPE=CELL:${PERSON.phone}`);
        if(PERSON.email) lines.push(`EMAIL;TYPE=INTERNET:${PERSON.email}`);
        if(PERSON.city) lines.push(`ADR;TYPE=WORK:;;;${PERSON.city};;;;`);
        lines.push(`URL:https://alicoempaques.com`);

        try{
          const imgInfo = await imageToBase64(avatar);
          if(imgInfo?.base64){
            const typePart = (imgInfo.mime?.split('/')[1]?.split('+')[0] || 'JPEG').toUpperCase();
            lines.push(`PHOTO;ENCODING=b;TYPE=${typePart}:${imgInfo.base64}`);
          }
        }catch(e){}

        lines.push('END:VCARD');

        const blob = new Blob([lines.join('\r\n')], {type: 'text/vcard;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fullName.replace(/[^a-z0-9\-_\. ]/ig,'_')}.vcf`;
        a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 100);
      };
    }

    // Analytics - non-blocking with timeout
    setTimeout(()=>{
      try{
        const data = {
          fecha: new Date().toISOString().slice(0,10),
          hora: new Date().toTimeString().slice(0,8),
          pagina: location.href
        };
        fetch('https://script.google.com/macros/s/AKfycbxCEmqnvMouAE-boKdW9lDAcZ3GmJh8I9N48a5TxQ0XDAiBmXPSfZzahDMzhpFO_JCNUg/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        }).catch(()=>{});
      }catch(e){}
    }, 1000);
  })();
  </script>
</body>
</html>